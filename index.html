<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NeuroSphere Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .message-ai { background: #f3f4f6; }
    .message-user { background: #3b82f6; color: white; }
    .dark .message-ai { background: #374151; color: white; }
    .dark .message-user { background: #1e40af; }
    
    .typing-animation::after {
      content: '...';
      animation: typing 1.5s infinite;
    }
    @keyframes typing {
      0%, 100% { opacity: 0; }
      50% { opacity: 1; }
    }

    .loading-dots::after {
      content: '.';
      animation: dots 1.5s infinite steps(3, end);
    }
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 h-screen flex flex-col transition-colors duration-200">
  <!-- –®–∞–ø–∫–∞ -->
  <header class="bg-gray-900 text-white p-4 shadow-md flex items-center">
    <h1 class="text-2xl font-bold">NeuroSphere</h1>
    
    <div class="ml-auto flex space-x-3">
      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã -->
      <button id="themeToggle" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600">
        <span id="themeIcon">üåô</span>
      </button>
      
      <!-- –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏ -->
      <select id="modelSelect" class="bg-gray-700 text-white rounded px-3 py-1">
        <option value="mistralai/Mistral-7B-v0.1">Mistral-7B</option>
        <option value="HuggingFaceH4/zephyr-7b-beta">Zephyr-7B</option>
        <option value="google/gemma-7b">Gemma-7B</option>
      </select>
    </div>
  </header>

  <!-- –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤ (—Å–∞–π–¥–±–∞—Ä) -->
  <div class="flex flex-1 overflow-hidden">
    <div id="chatHistory" class="w-64 bg-gray-100 dark:bg-gray-800 p-3 overflow-y-auto hidden md:block">
      <h3 class="font-bold mb-3 dark:text-white">–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</h3>
      <div id="historyList" class="space-y-2">
        <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
      </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç -->
    <div class="flex-1 flex flex-col">
      <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4">
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
      </div>

      <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
      <div class="p-4 border-t bg-white dark:bg-gray-800">
        <div class="flex space-x-2">
          <div class="flex-1 relative">
            <input 
              id="messageInput" 
              type="text" 
              placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
              class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
            >
            <button 
              id="voiceButton" 
              class="absolute right-3 top-3 text-gray-500 hover:text-blue-500"
              title="–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥"
            >
              üé§
            </button>
          </div>
          <button 
            id="sendButton" 
            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition dark:bg-blue-700 dark:hover:bg-blue-800"
          >
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const API_URL = 'https://neurosphere-08pk.onrender.com/api/chat';
    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const chatHistory = document.getElementById('chatHistory');
    const historyList = document.getElementById('historyList');
    let currentChatId = `chat_${Date.now()}`;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    document.addEventListener('DOMContentLoaded', () => {
      loadTheme();
      loadChatHistory();
      
      // –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–≤—ã–π —á–∞—Ç, –µ—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏
      if (!localStorage.getItem('neurosphere_chats')) {
        createNewChat();
      }
    });

    // ========================
    // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞
    // ========================

    async function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;

      // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      addMessage(message, 'user');
      saveMessageToHistory(message, 'user');
      messageInput.value = '';

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç"
      const typingIndicator = document.createElement('div');
      typingIndicator.className = 'typing-animation text-gray-500 italic dark:text-gray-400';
      typingIndicator.textContent = 'NeuroSphere –ø–µ—á–∞—Ç–∞–µ—Ç';
      chatContainer.appendChild(typingIndicator);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      try {
        // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–æ–¥–µ–ª—å
        const model = document.getElementById('modelSelect').value;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –±—ç–∫–µ–Ω–¥
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            message, 
            user_id: currentChatId,
            model // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–µ–ª—å –≤ –∑–∞–ø—Ä–æ—Å
          })
        });
        
        const data = await response.json();

        // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç
        chatContainer.removeChild(typingIndicator);
        addMessage(data.reply, 'ai');
        saveMessageToHistory(data.reply, 'ai');

      } catch (error) {
        chatContainer.removeChild(typingIndicator);
        addMessage('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å AI', 'error');
        console.error('API Error:', error);
      }
    }

    function addMessage(text, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `p-3 rounded-lg max-w-[80%] ${
        type === 'user' 
          ? 'message-user ml-auto' 
          : type === 'ai' 
            ? 'message-ai mr-auto' 
            : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
      }`;
      messageDiv.textContent = text;
      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ========================
    // –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤
    // ========================

    function createNewChat() {
      currentChatId = `chat_${Date.now()}`;
      chatContainer.innerHTML = '';
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π —á–∞—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
      const chats = JSON.parse(localStorage.getItem('neurosphere_chats') || '{}');
      chats[currentChatId] = {
        id: currentChatId,
        title: '–ù–æ–≤—ã–π —á–∞—Ç',
        messages: [],
        createdAt: new Date().toISOString()
      };
      localStorage.setItem('neurosphere_chats', JSON.stringify(chats));
      
      loadChatHistory();
      addMessage('–ü—Ä–∏–≤–µ—Ç! –Ø NeuroSphere. –ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?', 'ai');
    }

    function saveMessageToHistory(text, type) {
      const chats = JSON.parse(localStorage.getItem('neurosphere_chats') || '{}');
      if (chats[currentChatId]) {
        chats[currentChatId].messages.push({
          text,
          type,
          timestamp: new Date().toISOString()
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–µ—Ä–≤—ã–µ 20 —Å–∏–º–≤–æ–ª–æ–≤ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)
        if (chats[currentChatId].messages.length === 1) {
          chats[currentChatId].title = text.slice(0, 20) + (text.length > 20 ? '...' : '');
        }
        
        localStorage.setItem('neurosphere_chats', JSON.stringify(chats));
        loadChatHistory();
      }
    }

    function loadChatHistory() {
      const chats = JSON.parse(localStorage.getItem('neurosphere_chats') || '{}');
      historyList.innerHTML = '';
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞
      const newChatBtn = document.createElement('button');
      newChatBtn.className = 'w-full p-2 bg-blue-100 dark:bg-blue-900 rounded mb-3 text-left font-medium';
      newChatBtn.textContent = '+ –ù–æ–≤—ã–π —á–∞—Ç';
      newChatBtn.onclick = createNewChat;
      historyList.appendChild(newChatBtn);
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º —á–∞—Ç—ã –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
      Object.values(chats)
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
        .forEach(chat => {
          const chatEl = document.createElement('div');
          chatEl.className = `p-2 rounded cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 ${
            chat.id === currentChatId ? 'bg-gray-300 dark:bg-gray-600' : ''
          }`;
          chatEl.innerHTML = `
            <div class="font-medium truncate">${chat.title}</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">
              ${new Date(chat.createdAt).toLocaleString()}
            </div>
          `;
          chatEl.onclick = () => loadChat(chat.id);
          historyList.appendChild(chatEl);
        });
    }

    function loadChat(chatId) {
      const chats = JSON.parse(localStorage.getItem('neurosphere_chats') || '{}');
      if (chats[chatId]) {
        currentChatId = chatId;
        chatContainer.innerHTML = '';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
        chats[chatId].messages.forEach(msg => {
          addMessage(msg.text, msg.type);
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
        loadChatHistory();
      }
    }

    // ========================
    // –¢–µ–º–Ω–∞—è —Ç–µ–º–∞
    // ========================

    function loadTheme() {
      const isDark = localStorage.getItem('neurosphere_theme') === 'dark';
      document.body.classList.toggle('dark', isDark);
      document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    document.getElementById('themeToggle').addEventListener('click', () => {
      const isDark = document.body.classList.toggle('dark');
      localStorage.setItem('neurosphere_theme', isDark ? 'dark' : 'light');
      document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    });

    // ========================
    // –ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥
    // ========================

    document.getElementById('voiceButton').addEventListener('click', () => {
      if (!('webkitSpeechRecognition' in window)) {
        alert('–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ');
        return;
      }

      const recognition = new webkitSpeechRecognition();
      recognition.lang = 'ru-RU';
      recognition.interimResults = false;

      recognition.onstart = () => {
        messageInput.placeholder = '–ì–æ–≤–æ—Ä–∏—Ç–µ...';
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        messageInput.value = transcript;
      };

      recognition.onerror = (event) => {
        console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
      };

      recognition.onend = () => {
        messageInput.placeholder = '–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...';
      };

      recognition.start();
    });

    // ========================
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    // ========================

    document.getElementById('sendButton').addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é (–¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
    window.addEventListener('resize', () => {
      if (window.innerWidth < 768) {
        chatHistory.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
